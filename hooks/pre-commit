#!/bin/bash
# Compound Engineering Pre-Commit Hook
# Catches automatable anti-patterns before commit
#
# Install: ln -sf ~/.claude/learnings/hooks/pre-commit .git/hooks/pre-commit

RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0
WARNINGS=0

# Get staged JS/TS files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|jsx|tsx)$')

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

echo "Compound Engineering: checking staged files..."

# -----------------------------------------------------------------------------
# CHECK 1: Raw Unicode in strings that become HTML
# Focus on characters that cause mojibake: em-dash, en-dash, multiplication sign
# Curly quotes/apostrophes are often intentional in UI text, so just warn
# -----------------------------------------------------------------------------
for file in $STAGED_FILES; do
    # Check for em-dash (—), en-dash (–), × symbol - these cause mojibake
    if git show ":$file" 2>/dev/null | grep -n '[—–×]' | grep -v '^\s*//' > /dev/null; then
        echo -e "${RED}ERROR${NC}: $file contains characters that may render as mojibake"
        echo "       Use HTML entities: &mdash; &ndash; &times;"
        git show ":$file" | grep -n '[—–×]' | grep -v '^\s*//' | head -5
        ERRORS=$((ERRORS + 1))
    fi
    # Curly quotes are usually intentional, just warn
    if git show ":$file" 2>/dev/null | grep -n '[""'']' | grep -v '^\s*//' > /dev/null; then
        echo -e "${YELLOW}NOTE${NC}: $file contains curly quotes (usually OK in UI text)"
        WARNINGS=$((WARNINGS + 1))
    fi
done

# -----------------------------------------------------------------------------
# CHECK 2: fetch() without AbortController/signal
# Pattern: fetch( without signal in same statement
# -----------------------------------------------------------------------------
for file in $STAGED_FILES; do
    # Look for fetch calls, exclude those with 'signal'
    FETCH_LINES=$(git show ":$file" 2>/dev/null | grep -n 'fetch(' | grep -v 'signal')
    if [ -n "$FETCH_LINES" ]; then
        # Check if AbortController exists nearby (within 10 lines above)
        while IFS= read -r line; do
            LINE_NUM=$(echo "$line" | cut -d: -f1)
            START=$((LINE_NUM - 10))
            if [ $START -lt 1 ]; then START=1; fi
            CONTEXT=$(git show ":$file" 2>/dev/null | sed -n "${START},${LINE_NUM}p")
            if ! echo "$CONTEXT" | grep -q 'AbortController'; then
                echo -e "${YELLOW}WARNING${NC}: $file:$LINE_NUM - fetch() without visible timeout"
                echo "         Consider adding AbortController (see when-http-calls.md)"
                WARNINGS=$((WARNINGS + 1))
            fi
        done <<< "$FETCH_LINES"
    fi
done

# -----------------------------------------------------------------------------
# CHECK 3: textContent with HTML entities (won't render)
# Pattern: .textContent = '...&...;...'
# -----------------------------------------------------------------------------
for file in $STAGED_FILES; do
    if git show ":$file" 2>/dev/null | grep -n 'textContent.*&[a-z]*;' > /dev/null; then
        echo -e "${YELLOW}WARNING${NC}: $file has textContent with HTML entities"
        echo "         HTML entities don't render in textContent, use innerHTML or literal char"
        git show ":$file" | grep -n 'textContent.*&[a-z]*;' | head -3
        WARNINGS=$((WARNINGS + 1))
    fi
done

# -----------------------------------------------------------------------------
# SUMMARY
# -----------------------------------------------------------------------------
echo ""
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}Blocked${NC}: $ERRORS error(s) found. Fix before committing."
    echo "Reference: ~/.claude/learnings/when-*.md"
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}Passed with $WARNINGS warning(s)${NC}"
    echo "Reference: ~/.claude/learnings/when-*.md"
    exit 0
else
    echo "All checks passed."
    exit 0
fi
